{"version":3,"sources":["../../../../server/api/queue/queue.controller.js"],"names":[],"mappings":"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","file":"queue.controller.js","sourcesContent":["'use strict';\nvar Report = require('../report/report.model');\nconst child_process = require(\"child_process\").fork(\"server/components/queue/index.js\", [], { execArgv: ['--debug=5859'] });\nconst consumer = require(\"child_process\").fork(\"server/components/queue/index.js\", [], { execArgv: ['--debug=5860'] });\n\nchild_process.on('message', function(response) {\n    switch(response.event.type){\n        case 'info':\n            console.log(response.data.message);\n            break;\n        default:\n            console.log(\"Unknown event type:\" + response.event.type);\n    }\n});\n\nconsumer.on('message', function(response) {\n    switch(response.event.type){\n        case 'info':\n            console.log(response.data.message);\n            break;\n        case 'message':\n            var report = translateTweet(JSON.parse(response.data.message),true,false);\n            if (report){\n              var r = new Report();\n              for(var i in report){\n                r[i]=report[i];\n              }\n              r.save(function (err) {\n                if (err) console.log(err);\n              });\n            }\n\n            break;\n        default:\n            console.log(\"Unknown event type:\" + response.event.type);\n    }\n});\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nvar translateTweet = function(tweet, validateMedia, validateLocation){\n\n  var validMedia = tweet.entities && tweet.entities.media && tweet.entities.media.length;\n\n  var validLocation = tweet.coordinates && tweet.coordinates.coordinates && tweet.coordinates.coordinates.length;\n\n  if(validateMedia && !(validMedia)){\n    return;\n  }\n\n  if(validateLocation && !(validLocation)){\n    return;\n  }\n  var media;\n  if(validMedia){\n    media = [];\n    for (var i = 0; i < tweet.entities.media.length; i++) {\n      var item = tweet.entities.media[i];\n      media.push({\n        media_url:item.media_url,\n        media_url_https:item.media_url_https,\n        url:item.url,\n        display_url:item.display_url,\n        expanded_url:item.expanded_url,\n        type:item.type});\n    };\n  }\n\n  return{\n    updated: Date.now(),\n    created: Date.now(),\n    report_datetime: Date.now(),\n    due_datetime: Date.now(),\n    description: tweet.text,\n    media:media,\n    user:tweet.user.name,\n    loc: validLocation?tweet.coordinates.coordinates:[]\n  }\n}\n\nexport function start(req, res){\n    child_process.send({event:{type:\"start\"},data:{user:req.params.id}});\n    res.status(200).end();\n}\nexport function stop(req, res){\n    child_process.send({event:{type:\"stop\"},data:{user:req.params.id}});\n    res.status(200).end();\n}\nexport function refresh(req, res){\n    child_process.send({event:{type:\"refresh\"},data:{user:req.params.id}});\n    res.status(200).end();\n}\nexport function consume(req, res){\n    consumer.send({event:{type:\"consume\"},data:{user:req.params.id}});\n    res.status(200).end();\n}"]}