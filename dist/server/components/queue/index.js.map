{"version":3,"sources":["../../../../server/components/queue/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["var util = require('util');\r\nvar config = require('./config.js');\r\nvar database = require('./database.js')(config.db);\r\nvar twitter = require('./twitter.js')(config.twitter);\r\nvar queue = require('./queue.js')(config.queue);\r\nvar p = require('./prioritizer.js');\r\nvar m = require('./message.js');\r\nvar i18n = require('./en.i18n.js');\r\n\r\nvar manual_stop = false;\r\nvar auto_start = true;\r\nvar chords = [];\r\nvar message = {};\r\nvar queues = [];\r\nvar root = \"\";\r\n\r\nvar ondata = function (tweet) {\r\n    var q = p.prioritize(tweet.text, chords, root);\r\n    if (q) {\r\n        var str_tweet = m.process(tweet);\r\n        queue.enqueue(q, str_tweet);\r\n    }\r\n}\r\n\r\nvar onend = function(event_data) {\r\n    if (!manual_stop && auto_start){\r\n        process.send({event:{type:\"info\"},data:{message:i18n.AUTO_STARTING}});\r\n        start(message.data.user);\r\n    }\r\n    if(manual_stop){\r\n        process.send({event:{type:\"info\"},data:{message:i18n.MANUALLY_STOPPED}});\r\n    }\r\n}\r\n\r\nvar stream = function(pattern){\r\n    load_keywords(pattern);\r\n    twitter.start_stream(pattern.root,ondata,onend);\r\n}\r\n\r\nprocess.on('message', function(m){\r\n    message = m;\r\n    switch(m.event.type){\r\n        case 'start':\r\n            start(m.data.user);\r\n            break;\r\n        case 'stop':\r\n            stop(m.data.user);\r\n            break;\r\n        case 'refresh':\r\n            refresh(m.data.user);\r\n            break;\r\n        case 'consume':\r\n            consume(m.data.user);\r\n            break;\r\n        default:\r\n            process.send({event:{type:\"info\"},data:{message:i18n.UNKNOWN_EVENT}});\r\n    }\r\n});\r\n\r\nvar load_keywords = function(pattern){\r\n    chords = pattern.chords;\r\n    root = pattern.root;\r\n    queues.push(root);\r\n    for (var i = chords.length - 1; i >= 0; i--) {\r\n        queues.push(chords[i].chord);\r\n    }\r\n    process.send({event:{type:\"info\"},data:{message:i18n.NOW_LISTENING_TO + root}});\r\n    process.send({event:{type:\"info\"},data:{message:i18n.QUEUES + JSON.stringify(queues)}});\r\n}\r\n\r\nvar start = function(user){\r\n    process.send({event:{type:\"info\"},data:{message:i18n.STARTING}});\r\n    manual_stop = false;\r\n    database.get_pattern(user).then(stream);\r\n};\r\n\r\nvar stop = function(user){\r\n    process.send({event:{type:\"info\"},data:{message:i18n.STOPPING}});\r\n    manual_stop = true;\r\n    twitter.stop_stream();\r\n}\r\n\r\nvar refresh = function(user){\r\n    process.send({event:{type:\"info\"},data:{message:i18n.REFRESHING}});\r\n    database.get_pattern(user).then(load_keywords);\r\n}\r\n\r\nvar consume = function(user){\r\n    process.send({event:{type:\"info\"},data:{message:i18n.CONSUMING}});\r\n    database.get_pattern(user)\r\n    .then(load_keywords)\r\n    .then(function(){\r\n        for (var i = queues.length - 1; i >= 0; i--) {\r\n            queue.consume(queues[i],process_tweet);\r\n        };    \r\n    });\r\n\r\n}\r\n\r\nvar process_tweet = function(message){\r\n    process.send({event:{type:\"message\"},data:{message:message}});\r\n}"]}